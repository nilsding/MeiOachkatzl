let $no_pushdown= set statement optimizer_switch='condition_pushdown_for_subquery=off' for; 

create table t1 (t1_a int, t1_b int, t1_c int, t1_d int);
create table t2 (t2_e int, t2_f int, t2_g int);
create table t3 (t3_x int, t3_y int);

insert into t1 values
(1,1,18,1), (2,1,25,1), (1,3,40,1), (2,1,15,4),
(4,2,24,4), (3,2,23,1), (1,2,40,2), (3,4,17,2),
(5,5,65,1), (2,3,70,3),  (1,4,35,3), (2,3,25,3);

insert into t2 values
(1,2,38), (2,3,15), (1,3,40), (1,4,35),
(2,2,70), (3,4,23), (5,5,12), (5,4,17),
(3,3,17), (4,2,24), (2,5,25), (5,1,65);

insert into t3 values
(1,25), (1,18), (2,15), (4,24),
(1,35), (3,23), (3,17), (2,15);

create view v1 as
(
  select t3_x as v1_x, t3_y as v1_y from t3 where t3_x<=3
);

--echo # conjunctive subformula : pushing into HAVING
let $query=
select * from t1
where t1_c<25 and
  (t1_a,t1_c) in (select t2_e,max(t2_g) from t2 where t2_e<5 group by t2_e);

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # extracted and formula : pushing into HAVING
let $query=
select * from t1
where t1_c>55 and t1_b<4 and
  (t1_a,t1_b,t1_c) in
  (
    select t2_e,t2_f,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # extracted or formula : pushing into HAVING
let $query=
select * from t1
where (t1_c>60 or t1_c<25) and
  (t1_a,t1_b,t1_c) in
  (
    select t2_e,t2_f,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # extracted and-or formula : pushing into HAVING
let $query=
select * from t1
where ((t1_c>60 or t1_c<25) and t1_b>2) and
  (t1_a,t1_b,t1_c) in
  (
    select t2_e,t2_f,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # conjunctive subformula : pushing into HAVING
let $query=
select * from t1
where ((t1_a<2 or t1_d>3) and t1_b>1) and
  (t1_a,t1_b,t1_c) in
  (
    select t2_e,t2_f,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # using view in subquery definition : pushing into HAVING
let $query=
select * from t1
where t1_c>20 and
  (t1_a,t1_c) in
  (
    select v1_x,max(v1_y)
    from v1
    where v1_x>1
    group by v1_x
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # using equality : pushing into WHERE
let $query=
select * from t1,v1
where t1_c>20 and t1_c=v1_y and
  (t1_a,t1_c) in
  (
    select t2_e,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # conjunctive subformula : pushing into WHERE
let $query=
select * from t1
where t1_a<2 and
  (t1_a,t1_c) in
  (
    select t2_e,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # extracted and formula : pushing into WHERE
let $query=
select * from t1
where t1_a>2 and t1_a<5 and
  (t1_a,t1_c) in
  (
    select t2_e,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # extracted or formula : pushing into WHERE
let $query=
select * from t1
where (t1_a<2 or t1_a>=4) and
  (t1_a,t1_c) in
  (
    select t2_e,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # extracted and-or formula : pushing into WHERE
let $query=
select * from t1
where ((t1_a<2 or t1_a=5) and t1_b>3) and
  (t1_a,t1_b,t1_c) in
  (
    select t2_e,t2_f,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e,t2_f
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # extracted and-or formula : pushing into WHERE
let $query=
select * from t1
where ((t1_a<2 or t1_a=5) and t1_b>3) and
  (t1_a,t1_b,t1_c) in
  (
    select t2_e,t2_f,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e,t2_f
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # conjunctive subformula : pushing into WHERE
let $query=
select * from t1
where ((t1_b<3 or t1_d>2) and t1_a<2) and
  (t1_a,t1_b,t1_c) in
  (
    select t2_e,t2_f,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # using equalities : pushing into WHERE
let $query=
select * from t1
where t1_d=1 and t1_a=t1_d and
  (t1_a,t1_c) in
  (
    select t2_e,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # using equality : pushing into WHERE
let $query=
select * from t1
where t1_d>1 and t1_a=t1_d and
  (t1_a,t1_c) in
  (
    select t2_e,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # using view in subquery definition : pushing into WHERE
let $query=
select * from t1
where t1_a<3 and
  (t1_a,t1_c) in
  (
    select v1_x,max(v1_y)
    from v1
    where v1_x>1
    group by v1_x
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # using equality : pushing into WHERE
let $query=
select * from t1,v1
where t1_a=v1_x and v1_x<2 and v1_y>30 and
  (t1_a,t1_c) in
  (
    select t2_e,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

--echo # conjunctive subformula : pushing into WHERE
--echo # extracted or formula : pushing into HAVING
let $query=
select * from t1
where ((t1_b<3 or t1_b=4) and t1_a<3) and
  (t1_a,t1_b,t1_c) in
  (
    select t2_e,t2_f,max(t2_g)
    from t2
    where t2_e<5
    group by t2_e
  )
;

eval $no_pushdown $query;
eval $query;
eval explain $query;
eval explain format=json $query;

drop table t1,t2,t3;
drop view v1;
